<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAX | Data Integrated Management Auditor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "three": "https://esm.sh/three@0.160.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.16?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.99.0?external=react,react-dom,three,@react-three/fiber",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
                "uuid": "https://esm.sh/uuid@9.0.1",
                "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react"
            }
        }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700;800&display=swap');
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 2px; }
        
        body { 
            overflow: hidden; 
            background: linear-gradient(135deg, #f8fafc 0%, #cbd5e1 100%);
            font-family: 'JetBrains Mono', monospace; 
            color: #1e293b;
        }
        
        /* White Glass Panel */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(24px); 
            border: 1px solid rgba(255, 255, 255, 0.9); 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08); 
        }

        /* Tooltip Arrow Styling */
        .tooltip-arrow {
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 8px;
            height: 8px;
            background: white;
            border-top: 1px solid rgba(226, 232, 240, 1);
            border-left: 1px solid rgba(226, 232, 240, 1);
        }
        
        #root { height: 100vh; width: 100vw; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect, useMemo, useCallback, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Canvas, useThree } from '@react-three/fiber';
        import { OrbitControls, Grid, Html, useCursor, TransformControls, PerspectiveCamera, Environment, Text } from '@react-three/drei';
        import { 
            Box, Layers, PenTool, Trash2, MousePointer, Undo,
            Settings, Save, ArrowUpCircle, Axis3d, Ruler, 
            DollarSign, FileText, ScanLine, Upload, Zap, Image as ImageIcon, 
            FileImage, TrendingUp, Grid3X3, Calculator, PieChart, FileSpreadsheet, Plus, Copy, Eye, EyeOff,
            ToggleLeft, ToggleRight, LayoutTemplate, Magnet, Info, X, Cpu, Database, Glasses, MonitorSmartphone,
            Briefcase, Target, CheckCircle2, AlertCircle, ClipboardList, Download
        } from 'lucide-react';
        import * as THREE from 'three';
        import { v4 as uuidv4 } from 'uuid';
        import { motion } from 'framer-motion';

        // --- 1. CONFIGURATION ---

        const THEME = {
            primary: '#3b82f6', 
            accent: '#f59e0b',
            grid: '#94a3b8',
        };

        const INITIAL_MATERIALS = {
            'CONCRETE_C25': { id: 'MAT-01', name: 'Concrete C25', cost: 120, unit: 'm³' },
            'STEEL_S355':   { id: 'MAT-02', name: 'Steel S355', cost: 2400, unit: 'ton' },
            'GLASS_DBL':    { id: 'MAT-03', name: 'Glazing Dbl', cost: 450, unit: 'm²' },
            'COMPOSITE':    { id: 'MAT-04', name: 'Comp Panel', cost: 85, unit: 'm²' },
            'FURNITURE':    { id: 'MAT-05', name: 'Furnishing', cost: 500, unit: 'item' },
        };

        const DEFAULT_PROJECT_META = {
            title: "Executive Office Pod",
            code: "TRX-DEMO-10M",
            lead: "System Auditor",
            status: "SCHEMATIC",
            targetBudget: 15000,
            targetGFA: 10,
            description: "10m² demonstrator unit featuring structural steel columns, concrete shell, and composite furnishing elements to validate the Real-Time Cost-OS."
        };

        const IFC_MAPPING = {
            WALL: { type: 'IFCWALL', prefix: 'WAL', material: 'CONCRETE_C25' },
            COLUMN: { type: 'IFCCOLUMN', prefix: 'COL', material: 'STEEL_S355' },
            FURNITURE: { type: 'IFCFURNISHING', prefix: 'FUR', material: 'FURNITURE' },
            SLAB: { type: 'IFCSLAB', prefix: 'SLB', material: 'CONCRETE_C25' }
        };

        const LAYER_DEFS = {
            'IFCWALL': { label: 'WALLS', icon: Box, color: '#64748b' },
            'IFCCOLUMN': { label: 'STRUCTURE', icon: Grid3X3, color: '#f59e0b' },
            'IFCSLAB': { label: 'SLABS', icon: Layers, color: '#475569' },
            'IFCFURNISHING': { label: 'FURNITURE', icon: LayoutTemplate, color: '#8b5cf6' }
        };

        const GRID_SIZE = 10;

        // --- 2. ENGINE COMPONENTS ---

        // ANIMATED TRAX LOGO
        const TraxLogo = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" className="overflow-visible">
                <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stopColor="#3b82f6" />
                        <stop offset="100%" stopColor="#8b5cf6" />
                    </linearGradient>
                </defs>
                <line x1="0" y1="22" x2="24" y2="22" stroke="#cbd5e1" strokeWidth="1" />
                <line x1="2" y1="24" x2="2" y2="10" stroke="#cbd5e1" strokeWidth="1" />
                <motion.path
                    d="M2 20 L8 16 L14 18 L22 4"
                    fill="none"
                    stroke="url(#logoGradient)"
                    strokeWidth="3"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    initial={{ pathLength: 0, opacity: 0 }}
                    animate={{ pathLength: 1, opacity: 1 }}
                    transition={{ 
                        duration: 1.5, 
                        ease: "circOut",
                        repeat: Infinity,
                        repeatDelay: 3
                    }}
                />
                <circle cx="22" cy="4" r="2" fill="#3b82f6" />
            </svg>
        );

        const Tooltip = ({ text, children }) => (
            <div className="relative group flex flex-col items-center justify-center">
                {children}
                <div className="absolute top-full mt-3 px-3 py-2 bg-white/90 border border-slate-200/50 rounded-lg text-[10px] font-bold tracking-wide text-slate-700 opacity-0 group-hover:opacity-100 transition-all duration-200 pointer-events-none whitespace-nowrap z-[100] shadow-xl backdrop-blur-md translate-y-1 group-hover:translate-y-0">
                    <div className="tooltip-arrow"></div>
                    {text}
                </div>
            </div>
        );

        const BimElement = React.memo(({ element, isSelected, onSelect, mode, onTransformEnd, setOrbitEnabled, materialDb, isGhosted, snap }) => {
            const [hovered, setHover] = useState(false);
            const meshRef = useRef();
            useCursor(hovered, 'pointer', 'auto');

            const dims = useMemo(() => {
                const p = element.params;
                if (element.type === 'IFCWALL') return [Math.max(0.1, p.length), Math.max(0.1, p.height), Math.max(0.05, p.thickness)];
                if (element.type === 'IFCSLAB') return [Math.max(1, p.width), 0.2, Math.max(1, p.depth)];
                return [Math.max(0.1, p.width), Math.max(0.1, p.height), Math.max(0.1, p.depth)];
            }, [element.params, element.type]);

            const showGizmo = isSelected && ['translate', 'rotate'].includes(mode);
            const opacity = isGhosted ? 0.1 : (isSelected ? 0.9 : 0.8);
            const color = isSelected ? THEME.accent : element.color;
            const meshPos = [0, dims[1]/2, 0]; 

            return (
                <group position={element.position} rotation={element.rotation}>
                    <group
                        ref={meshRef}
                        onClick={(e) => { e.stopPropagation(); onSelect(element.id); }}
                        onPointerOver={() => setHover(true)}
                        onPointerOut={() => setHover(false)}
                    >
                        <mesh castShadow={!isGhosted} receiveShadow position={meshPos}>
                            <boxGeometry args={dims} />
                            <meshStandardMaterial 
                                color={color}
                                roughness={0.4} 
                                metalness={0.2}
                                transparent={true}
                                opacity={opacity}
                                depthWrite={!isGhosted}
                            />
                            <lineSegments>
                                <edgesGeometry args={[new THREE.BoxGeometry(...dims)]} />
                                <lineBasicMaterial color={isSelected ? '#ffffff' : '#334155'} linewidth={1} transparent opacity={isGhosted ? 0.05 : 0.3} />
                            </lineSegments>
                        </mesh>
                    </group>

                    {showGizmo && meshRef.current && (
                        <TransformControls 
                            object={meshRef.current.parent} 
                            mode={mode === 'rotate' ? 'rotate' : 'translate'} 
                            size={0.8}
                            translationSnap={snap ? 0.5 : null}
                            rotationSnap={snap ? Math.PI / 4 : null}
                            onMouseDown={() => setOrbitEnabled(false)}
                            onMouseUp={(e) => { 
                                setOrbitEnabled(true);
                                if (e?.target?.object) setTimeout(() => onTransformEnd(element.id, e.target.object), 0);
                            }}
                        />
                    )}
                </group>
            );
        });

        // --- 3. SUB-COMPONENTS ---

        const BoqScreen = ({ elements, materials, meta, onClose }) => {
            const boqData = useMemo(() => {
                const data = {};
                elements.forEach(el => {
                    const matKey = el.data?.materialKey || 'CONCRETE_C25';
                    const mat = materials[matKey] || materials['CONCRETE_C25'];
                    
                    let qty = 1;
                    const p = el.params;
                    if(el.type === 'IFCWALL') qty = p.length * p.height * p.thickness;
                    else if(el.type === 'IFCCOLUMN') qty = p.height * p.width * p.depth;
                    else if(el.type === 'IFCSLAB') qty = p.width * 0.2 * p.depth;
                    
                    if (!data[matKey]) {
                        data[matKey] = { name: mat.name, unit: mat.unit, unitCost: mat.cost, quantity: 0, totalCost: 0, count: 0 };
                    }
                    data[matKey].quantity += qty;
                    data[matKey].totalCost += (qty * mat.cost);
                    data[matKey].count += 1;
                });
                return Object.values(data).sort((a,b) => b.totalCost - a.totalCost);
            }, [elements, materials]);

            const totalBoqCost = boqData.reduce((sum, item) => sum + item.totalCost, 0);

            const exportBoqCSV = () => {
                const headers = ["Material / Assembly", "Objects Count", "Quantity", "Unit", "Unit Cost", "Total Cost"];
                const rows = boqData.map(item => [
                    `"${item.name}"`, 
                    item.count, 
                    item.quantity.toFixed(2), 
                    item.unit, 
                    item.unitCost, 
                    item.totalCost.toFixed(2)
                ]);
                
                const csvContent = "data:text/csv;charset=utf-8," + [
                    ["PROJECT: " + meta.title, "CODE: " + meta.code].join(","),
                    ["BILL OF QUANTITIES"],
                    [],
                    headers.join(","),
                    ...rows.map(r => r.join(","))
                ].join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `TRAX_${meta.code}_BoQ.csv`);
                document.body.appendChild(link);
                link.click();
            };

            return (
                <div className="absolute inset-0 z-50 bg-slate-900/40 flex items-center justify-center p-8 backdrop-blur-sm animate-in zoom-in-95 duration-200">
                    <div className="glass-panel rounded-2xl p-0 w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden relative shadow-2xl">
                        <div className="p-6 border-b border-slate-200 bg-white/60 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-emerald-600 rounded-xl text-white shadow-lg shadow-emerald-500/30">
                                    <ClipboardList size={24} />
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-slate-800">REAL-TIME BoQ</h2>
                                    <p className="text-xs text-slate-500 font-mono tracking-widest">BILL OF QUANTITIES & MATERIAL MANIFEST</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white rounded-full text-slate-400 hover:text-slate-800 transition-colors">
                                <X size={24} />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-8">
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="border-b border-slate-300 text-[10px] uppercase tracking-widest text-slate-400">
                                        <th className="pb-3 font-bold">Material / Assembly</th>
                                        <th className="pb-3 font-bold text-center">Objects</th>
                                        <th className="pb-3 font-bold text-right">Quantity</th>
                                        <th className="pb-3 font-bold text-right">Unit Cost</th>
                                        <th className="pb-3 font-bold text-right">Total Cost</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm">
                                    {boqData.map((item, idx) => (
                                        <tr key={idx} className="border-b border-slate-200/50 hover:bg-white/50 transition-colors">
                                            <td className="py-4 font-bold text-slate-700">{item.name}</td>
                                            <td className="py-4 text-center text-slate-500 font-mono">{item.count}</td>
                                            <td className="py-4 text-right text-blue-600 font-mono font-bold">
                                                {item.quantity.toLocaleString(undefined, {maximumFractionDigits:2})} <span className="text-[10px] text-slate-400 ml-1">{item.unit}</span>
                                            </td>
                                            <td className="py-4 text-right text-slate-600 font-mono">
                                                ${item.unitCost.toLocaleString()}
                                            </td>
                                            <td className="py-4 text-right text-emerald-600 font-mono font-bold">
                                                ${item.totalCost.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}
                                            </td>
                                        </tr>
                                    ))}
                                    {boqData.length === 0 && (
                                        <tr><td colSpan="5" className="py-8 text-center text-slate-400 text-xs font-bold tracking-widest uppercase">No Assets Found in Project</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>

                        <div className="p-6 border-t border-slate-200 bg-white/60 flex justify-between items-center">
                            <div className="text-xs text-slate-500 font-bold uppercase tracking-widest flex items-center">
                                TOTAL ESTIMATE: <span className="text-xl text-emerald-600 font-black ml-3">${totalBoqCost.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
                            </div>
                            <button onClick={exportBoqCSV} className="px-6 py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/30 hover:bg-emerald-500 transition-all flex items-center gap-2 text-xs">
                                <Download size={16}/> EXPORT BoQ TO CSV
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ProjectScreen = ({ meta, setMeta, stats, levels, onClose }) => {
            // Calculations for Metering
            const budgetPercent = Math.min((stats.totalCost / meta.targetBudget) * 100, 100);
            const gfaPercent = Math.min((stats.totalGFA / meta.targetGFA) * 100, 100);
            
            return (
                <div className="absolute inset-0 z-50 bg-slate-100/50 flex items-center justify-center p-8 backdrop-blur-sm animate-in zoom-in-95 duration-200">
                    <div className="glass-panel rounded-2xl p-0 w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden relative shadow-2xl">
                        {/* Header */}
                        <div className="p-6 border-b border-white bg-white/40 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-blue-600 rounded-xl text-white shadow-lg shadow-blue-500/30">
                                    <Briefcase size={24} />
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-slate-800">PROJECT DASHBOARD</h2>
                                    <p className="text-xs text-slate-500 font-mono tracking-widest">TEMPLATE & METERING CONFIGURATION</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white rounded-full text-slate-400 hover:text-slate-800 transition-colors">
                                <X size={24} />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-8 grid grid-cols-12 gap-8">
                            
                            {/* Left Column: Metadata Inputs */}
                            <div className="col-span-4 space-y-6">
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2 mb-4">
                                    <FileText size={14}/> Project Identity
                                </h3>
                                
                                <div className="space-y-4">
                                    <div className="group">
                                        <label className="text-[10px] font-bold text-slate-500 block mb-1">PROJECT TITLE</label>
                                        <input 
                                            type="text" value={meta.title} 
                                            onChange={(e) => setMeta({...meta, title: e.target.value})}
                                            className="w-full bg-white border border-slate-200 rounded p-2 text-sm font-bold text-slate-800 focus:border-blue-500 focus:outline-none shadow-sm transition-all"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 block mb-1">JOB CODE</label>
                                            <input 
                                                type="text" value={meta.code}
                                                onChange={(e) => setMeta({...meta, code: e.target.value})}
                                                className="w-full bg-white border border-slate-200 rounded p-2 text-xs font-mono text-slate-600 focus:border-blue-500 focus:outline-none shadow-sm"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 block mb-1">LEAD ARCHITECT</label>
                                            <input 
                                                type="text" value={meta.lead}
                                                onChange={(e) => setMeta({...meta, lead: e.target.value})}
                                                className="w-full bg-white border border-slate-200 rounded p-2 text-xs text-slate-600 focus:border-blue-500 focus:outline-none shadow-sm"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 block mb-1">STATUS</label>
                                        <select 
                                            value={meta.status}
                                            onChange={(e) => setMeta({...meta, status: e.target.value})}
                                            className="w-full bg-white border border-slate-200 rounded p-2 text-xs font-bold text-slate-700 focus:border-blue-500 focus:outline-none shadow-sm cursor-pointer"
                                        >
                                            <option value="DRAFT">DRAFT / CONCEPT</option>
                                            <option value="SCHEMATIC">SCHEMATIC DESIGN</option>
                                            <option value="DD">DESIGN DEVELOPMENT</option>
                                            <option value="CD">CONSTRUCTION DOCS</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 block mb-1">DESCRIPTION</label>
                                        <textarea 
                                            value={meta.description}
                                            onChange={(e) => setMeta({...meta, description: e.target.value})}
                                            className="w-full bg-white border border-slate-200 rounded p-2 text-xs text-slate-600 focus:border-blue-500 focus:outline-none shadow-sm resize-none h-24"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Middle Column: Metering & Targets */}
                            <div className="col-span-5 space-y-6">
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2 mb-4">
                                    <Target size={14}/> Performance Metering
                                </h3>

                                <div className="bg-white/50 border border-white rounded-xl p-6 shadow-sm space-y-6">
                                    {/* Cost Meter */}
                                    <div>
                                        <div className="flex justify-between items-end mb-2">
                                            <label className="text-[10px] font-bold text-slate-500">BUDGET UTILIZATION</label>
                                            <div className="text-right">
                                                <span className={`text-lg font-black ${stats.totalCost > meta.targetBudget ? 'text-red-500' : 'text-emerald-600'}`}>
                                                    ${(stats.totalCost/1000).toFixed(1)}k
                                                </span>
                                                <span className="text-[10px] text-slate-400 ml-1">/ ${meta.targetBudget/1000}k</span>
                                            </div>
                                        </div>
                                        <div className="h-4 bg-slate-200 rounded-full overflow-hidden relative">
                                            <div 
                                                className={`absolute top-0 left-0 h-full transition-all duration-500 ${stats.totalCost > meta.targetBudget ? 'bg-red-500' : 'bg-emerald-500'}`}
                                                style={{ width: `${Math.min((stats.totalCost/meta.targetBudget)*100, 100)}%` }}
                                            ></div>
                                            {/* Threshold Marker */}
                                            <div className="absolute top-0 bottom-0 w-0.5 bg-slate-900/20" style={{left: '80%'}} title="80% Warning"></div>
                                        </div>
                                        <div className="mt-2">
                                            <label className="text-[9px] font-bold text-slate-400">SET TARGET BUDGET ($)</label>
                                            <input 
                                                type="number" step="10000"
                                                value={meta.targetBudget}
                                                onChange={(e) => setMeta({...meta, targetBudget: parseFloat(e.target.value)})}
                                                className="w-full mt-1 bg-white border border-slate-200 rounded p-1.5 text-xs font-mono text-slate-600 focus:border-emerald-500 focus:outline-none"
                                            />
                                        </div>
                                    </div>

                                    <div className="h-px bg-slate-200"></div>

                                    {/* GFA Meter */}
                                    <div>
                                        <div className="flex justify-between items-end mb-2">
                                            <label className="text-[10px] font-bold text-slate-500">GFA EFFICIENCY</label>
                                            <div className="text-right">
                                                <span className="text-lg font-black text-blue-600">
                                                    {(stats.totalGFA).toFixed(0)}
                                                </span>
                                                <span className="text-[10px] text-slate-400 ml-1">/ {meta.targetGFA} m²</span>
                                            </div>
                                        </div>
                                        <div className="h-4 bg-slate-200 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-blue-500 transition-all duration-500"
                                                style={{ width: `${Math.min((stats.totalGFA/meta.targetGFA)*100, 100)}%` }}
                                            ></div>
                                        </div>
                                        <div className="mt-2">
                                            <label className="text-[9px] font-bold text-slate-400">SET TARGET AREA (m²)</label>
                                            <input 
                                                type="number" step="50"
                                                value={meta.targetGFA}
                                                onChange={(e) => setMeta({...meta, targetGFA: parseFloat(e.target.value)})}
                                                className="w-full mt-1 bg-white border border-slate-200 rounded p-1.5 text-xs font-mono text-slate-600 focus:border-blue-500 focus:outline-none"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Right Column: Structure */}
                            <div className="col-span-3 space-y-6">
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2 mb-4">
                                    <Layers size={14}/> Template Structure
                                </h3>
                                <div className="bg-white/40 border border-white rounded-xl p-4 h-full">
                                    <div className="text-[10px] font-bold text-slate-500 mb-2">ACTIVE LEVELS</div>
                                    <div className="space-y-2 mb-6">
                                        {levels.map(l => (
                                            <div key={l.id} className="flex justify-between items-center text-xs bg-white p-2 rounded border border-slate-100 shadow-sm">
                                                <span className="font-bold text-slate-700">{l.name}</span>
                                                <span className="font-mono text-slate-400">{l.elevation}m</span>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <div className="text-[10px] font-bold text-slate-500 mb-2">LAYER CONFIG</div>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.values(LAYER_DEFS).map(ld => (
                                            <div key={ld.label} className="flex items-center gap-2 text-[10px] text-slate-600 bg-white/50 p-1.5 rounded">
                                                <div className="w-2 h-2 rounded-full" style={{background: ld.color}}></div>
                                                {ld.label}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-6 border-t border-white bg-white/60 flex justify-between items-center">
                            <div className="flex items-center gap-2 text-xs text-slate-500">
                                <CheckCircle2 size={14} className="text-emerald-500"/>
                                <span>Changes are auto-saved to local kernel state.</span>
                            </div>
                            <button onClick={onClose} className="px-8 py-3 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-slate-800 transition-all flex items-center gap-2 text-xs">
                                RETURN TO WORKSPACE
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const InfoScreen = ({ onClose }) => (
            <div className="absolute inset-0 z-50 bg-slate-100/50 flex items-center justify-center p-8 backdrop-blur-sm animate-in fade-in duration-300">
                <div className="glass-panel rounded-2xl p-8 w-full max-w-4xl max-h-full overflow-y-auto relative border-white">
                    <button onClick={onClose} className="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-800 transition-colors">
                        <X size={24} />
                    </button>
                    
                    <div className="flex flex-col gap-6">
                        <div className="flex items-center gap-4 border-b border-slate-200 pb-6">
                            <div className="w-16 h-16 bg-white/50 rounded-2xl flex items-center justify-center border border-slate-200 shadow-sm">
                                <TraxLogo />
                            </div>
                            <div>
                                <h1 className="text-3xl font-black tracking-tighter text-slate-800 mb-1">TRAX <span className="text-blue-600">KERNEL</span></h1>
                                <p className="text-sm font-mono text-slate-500 tracking-widest">DATA INTEGRATED MANAGEMENT AUDITOR v2.1</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-4">
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                    <Cpu size={14} /> System Architecture
                                </h3>
                                <p className="text-sm text-slate-600 leading-relaxed font-medium">
                                    TRAX is a high-performance BIM kernel engineered for real-time facility auditing. Utilizing a hybrid <strong>React-Three-Fiber</strong> engine, it delivers lightweight parametric modeling without heavy CAD overhead.
                                </p>
                                <p className="text-sm text-slate-600 leading-relaxed">
                                    Features a <strong>Relative Coordinate Level Manager</strong> for dynamic vertical stacking and persistent state management via local graph storage.
                                </p>
                            </div>

                            <div className="space-y-4">
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                    <Database size={14} /> Core Capabilities
                                </h3>
                                <ul className="space-y-3">
                                    <li className="flex items-start gap-3">
                                        <div className="p-1.5 bg-emerald-100 rounded text-emerald-600 mt-0.5"><DollarSign size={12}/></div>
                                        <div>
                                            <strong className="text-slate-800 text-xs block">Real-Time Cost-OS</strong>
                                            <span className="text-[10px] text-slate-500">Live valuation based on parametric volume & material cost drivers.</span>
                                        </div>
                                    </li>
                                    <li className="flex items-start gap-3">
                                        <div className="p-1.5 bg-purple-100 rounded text-purple-600 mt-0.5"><Layers size={12}/></div>
                                        <div>
                                            <strong className="text-slate-800 text-xs block">Ghosting Context Engine</strong>
                                            <span className="text-[10px] text-slate-500">Active level isolation with vertical context rendering.</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        {/* VR / SPATIAL COMPUTING SECTION */}
                        <div className="grid grid-cols-1 gap-6 pt-4 border-t border-slate-200">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                <Glasses size={14} /> Spatial Computing & Hardware
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-white/40 p-4 rounded-xl border border-white">
                                    <div className="flex items-center gap-2 mb-2">
                                        <Glasses size={16} className="text-indigo-600"/>
                                        <span className="text-xs font-bold text-slate-700">WebXR Compatibility</span>
                                    </div>
                                    <p className="text-[10px] text-slate-500 leading-relaxed">
                                        Engine is <strong>WebXR compliant</strong>, supporting <strong>Meta Quest (2/3/Pro)</strong>, <strong>Apple Vision Pro</strong>, and tethered PC-VR (HTC Vive, Index) via browser.
                                    </p>
                                </div>
                                <div className="bg-white/40 p-4 rounded-xl border border-white">
                                    <div className="flex items-center gap-2 mb-2">
                                        <MonitorSmartphone size={16} className="text-blue-600"/>
                                        <span className="text-xs font-bold text-slate-700">Hardware Handshake</span>
                                    </div>
                                    <p className="text-[10px] text-slate-500 leading-relaxed">
                                        <strong>Automatic Recognition:</strong> No manual driver installation required. The kernel automatically detects headset type and input capabilities (Hands vs. Controllers) upon session entry.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white/40 rounded-xl p-4 border border-white mt-2">
                            <div className="flex justify-between items-center">
                                <div className="flex gap-8 text-[10px] font-mono text-slate-400">
                                    <span>RENDER: WEBGL2</span>
                                    <span>PRECISION: FP32</span>
                                    <span>STATE: PERSISTENT</span>
                                </div>
                                <button onClick={onClose} className="bg-slate-900 hover:bg-slate-800 text-white px-6 py-2 rounded-lg text-xs font-bold transition shadow-lg">
                                    INITIALIZE SYSTEM
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const LevelManager = ({ levels, activeLevelId, setActiveLevelId, addLevel, updateLevel, projectStats }) => (
            <div className="flex flex-col gap-4 h-full pointer-events-none">
                <div className="glass-panel rounded-xl p-4 flex flex-col gap-2 max-h-[40%] pointer-events-auto">
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="text-xs font-bold text-slate-400 flex items-center gap-2 tracking-wider"><Layers size={12}/> LEVELS</h3>
                        <Tooltip text="Create New Level">
                            <button onClick={addLevel} className="p-1.5 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-md transition shadow-sm border border-blue-200"><Plus size={14}/></button>
                        </Tooltip>
                    </div>
                    <div className="space-y-1 overflow-y-auto pr-1">
                        {[...levels].reverse().map(l => (
                            <div 
                                key={l.id}
                                onClick={() => setActiveLevelId(l.id)}
                                className={`p-3 rounded-lg cursor-pointer border transition-all flex justify-between items-center group shadow-sm ${activeLevelId === l.id ? 'bg-white border-blue-400 ring-1 ring-blue-100' : 'bg-white/40 border-transparent hover:bg-white hover:border-slate-200'}`}
                            >
                                <div>
                                    <div className={`text-xs font-bold ${activeLevelId === l.id ? 'text-slate-900' : 'text-slate-500'}`}>{l.name}</div>
                                    <div className="text-[10px] font-mono text-slate-400 flex items-center gap-1 mt-0.5">
                                        ELEV: 
                                        <input 
                                            type="number" 
                                            value={l.elevation} 
                                            onClick={(e) => e.stopPropagation()}
                                            onChange={(e) => updateLevel(l.id, parseFloat(e.target.value))}
                                            className="w-12 bg-transparent border-b border-slate-300 focus:border-blue-500 text-slate-600 focus:text-slate-900 outline-none text-right transition-colors"
                                        />m
                                    </div>
                                </div>
                                {activeLevelId === l.id && <div className="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]"></div>}
                            </div>
                        ))}
                    </div>
                </div>

                <div className="glass-panel rounded-xl p-4 flex-1 pointer-events-auto">
                    <h3 className="text-xs font-bold text-slate-400 flex items-center gap-2 mb-4 tracking-wider"><Calculator size={12}/> METRICS</h3>
                    <div className="space-y-5">
                        <div className="bg-white/40 p-3 rounded-lg border border-white">
                            <div className="text-[9px] text-slate-400 uppercase tracking-widest font-bold mb-1">GROSS FLOOR AREA</div>
                            <div className="text-2xl font-black text-slate-700">{projectStats.levelStats[activeLevelId]?.gfa.toFixed(1) || 0} <span className="text-xs font-normal text-slate-400">m²</span></div>
                        </div>
                        <div className="flex justify-between items-center px-1">
                            <div className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">ASSET COUNT</div>
                            <div className="text-lg font-bold text-blue-600">{projectStats.levelStats[activeLevelId]?.items || 0} <span className="text-[9px] text-slate-400 font-normal">OBJS</span></div>
                        </div>
                        <div className="h-px bg-gradient-to-r from-transparent via-slate-300 to-transparent"></div>
                        <div className="px-1">
                            <div className="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">VALUATION</div>
                            <div className="text-xl font-bold text-emerald-600 font-mono">${((projectStats.levelStats[activeLevelId]?.cost || 0) / 1000).toFixed(1)}k</div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const PropertyPanel = ({ selectedElement, materials, setElements, setSelectedId, elements, showCostDrivers, setShowCostDrivers, setMaterials, INITIAL_MATERIALS }) => (
             <div className="glass-panel rounded-xl p-4 flex-1 overflow-auto animate-in slide-in-from-right-4 pointer-events-auto">
                {showCostDrivers ? (
                    <div>
                        <h3 className="text-xs font-bold text-amber-600 mb-4 flex items-center gap-2 tracking-wider"><Settings size={12}/> COST DRIVERS</h3>
                        <div className="space-y-3">
                            {Object.entries(materials).map(([key, mat]) => (
                                <div key={key} className="group bg-white/40 p-3 rounded-lg border border-transparent hover:border-white transition-all">
                                    <div className="flex justify-between text-[10px] text-slate-600 mb-1 font-bold">
                                        <span>{mat.name}</span>
                                        <span className="font-mono opacity-50 font-normal">per {mat.unit}</span>
                                    </div>
                                    <div className="relative">
                                        <span className="absolute left-2 top-1.5 text-xs text-slate-400">$</span>
                                        <input 
                                            type="number" 
                                            value={mat.cost}
                                            onChange={(e) => setMaterials({...materials, [key]: {...mat, cost: parseFloat(e.target.value)}})}
                                            className="w-full bg-white border border-slate-200 rounded p-1.5 pl-5 text-xs font-bold text-slate-700 focus:border-amber-400 focus:ring-1 focus:ring-amber-200 focus:outline-none transition-all"
                                        />
                                    </div>
                                </div>
                            ))}
                            <button onClick={() => setMaterials(INITIAL_MATERIALS)} className="w-full py-2 text-[10px] text-slate-500 hover:text-slate-700 hover:bg-slate-100 border border-dashed border-slate-300 rounded mt-4 transition-colors">RESET DEFAULTS</button>
                        </div>
                    </div>
                ) : selectedElement ? (
                    <div>
                        <div className="flex justify-between items-start mb-4 border-b border-slate-200 pb-3">
                            <div>
                                <div className="text-sm font-black text-slate-800">{selectedElement.tag}</div>
                                <div className="text-[10px] font-mono text-blue-500">{selectedElement.id.slice(0,8)}</div>
                            </div>
                            <Tooltip text="Delete Object">
                                <button onClick={() => {setElements(elements.filter(e=>e.id!==selectedElement.id)); setSelectedId(null)}} className="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors"><Trash2 size={14}/></button>
                            </Tooltip>
                        </div>
                        
                        <div className="space-y-4">
                            <div className="bg-white/40 p-2 rounded-lg">
                                <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">TYPE</div>
                                <div className="bg-white border border-slate-200 p-2 rounded text-xs text-slate-600 font-mono shadow-sm">{selectedElement.type}</div>
                            </div>
                            <div>
                                <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">MATERIAL</div>
                                <select 
                                    value={selectedElement.data.materialKey}
                                    onChange={(e) => setElements(elements.map(el => el.id === selectedElement.id ? {...el, data: {...el.data, materialKey: e.target.value}} : el))}
                                    className="w-full bg-white border border-slate-200 p-2 rounded text-xs text-slate-700 font-bold focus:outline-none focus:border-blue-400 cursor-pointer shadow-sm"
                                >
                                    {Object.entries(materials).map(([k, m]) => <option key={k} value={k}>{m.name}</option>)}
                                </select>
                            </div>
                            
                            {selectedElement.type === 'IFCWALL' && (
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">LENGTH (m)</div>
                                        <input type="number" step="0.1" value={selectedElement.params.length} 
                                            onChange={e => setElements(elements.map(el => el.id===selectedElement.id ? {...el, params:{...el.params, length: parseFloat(e.target.value)}} : el))}
                                            className="w-full bg-white border border-slate-200 p-2 rounded text-xs text-slate-700 shadow-sm focus:border-blue-400 focus:outline-none" />
                                    </div>
                                    <div>
                                        <div className="text-[9px] text-slate-400 font-bold mb-1 uppercase">HEIGHT (m)</div>
                                        <input type="number" step="0.1" value={selectedElement.params.height} 
                                            onChange={e => setElements(elements.map(el => el.id===selectedElement.id ? {...el, params:{...el.params, height: parseFloat(e.target.value)}} : el))}
                                            className="w-full bg-white border border-slate-200 p-2 rounded text-xs text-slate-700 shadow-sm focus:border-blue-400 focus:outline-none" />
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                ) : (
                    <div className="h-full flex flex-col items-center justify-center opacity-30">
                        <MousePointer size={48} className="text-slate-400 mb-2"/>
                        <p className="text-xs text-center font-bold text-slate-500 tracking-widest">SELECT OBJECT</p>
                    </div>
                )}
            </div>
        );

        // --- 4. SCENE GRAPH ---

        const SceneGraph = ({ levels, elements, activeLevelId, viewMode, layerVis, materials, mode, selectedId, setSelectedId, handleUpdate, setOrbitEnabled, snap }) => {
            return (
                <>
                    <ambientLight intensity={0.8} />
                    <directionalLight position={[20, 30, 10]} intensity={1.2} castShadow shadow-mapSize={[2048,2048]} color="#ffffff" />
                    <Environment preset="apartment" />

                    {levels.map(level => {
                        const isLevelActive = level.id === activeLevelId;
                        const levelElements = elements.filter(el => el.levelId === level.id);

                        return (
                            <group key={level.id} position={[0, level.elevation, 0]}>
                                {isLevelActive && (
                                    <>
                                        <Grid infiniteGrid cellSize={1} sectionSize={GRID_SIZE} sectionColor="#94a3b8" cellColor="#e2e8f0" fadeDistance={40} />
                                        <Text position={[12, 0, 12]} rotation={[-Math.PI/2, 0, 0]} fontSize={2} color="#3b82f6" fillOpacity={0.2} fontWeight={800}>
                                            {level.name.toUpperCase()}
                                        </Text>
                                    </>
                                )}

                                {levelElements.map(el => {
                                    if (!layerVis[el.type]) return null;
                                    
                                    if (viewMode === 'ISOLATE' && !isLevelActive) return null;
                                    const isGhosted = (viewMode === 'GHOST' && !isLevelActive);

                                    return (
                                        <BimElement 
                                            key={el.id} 
                                            element={el} 
                                            isSelected={selectedId === el.id} 
                                            onSelect={setSelectedId} 
                                            mode={mode} 
                                            onTransformEnd={handleUpdate}
                                            setOrbitEnabled={setOrbitEnabled}
                                            materialDb={materials}
                                            isGhosted={isGhosted}
                                            snap={snap}
                                        />
                                    );
                                })}
                            </group>
                        );
                    })}
                </>
            );
        };

        // --- 5. MAIN APP ---

        function TraxApp() {
            // -- State --
            const [levels, setLevels] = useState(() => JSON.parse(localStorage.getItem('trax_levels')) || [{ id: 'L1', name: 'Level 1', elevation: 0 }]);
            const [activeLevelId, setActiveLevelId] = useState('L1');
            
            // DEMO INITIALIZATION 
            const [elements, setElements] = useState(() => {
                const local = localStorage.getItem('trax_elements');
                if (local) return JSON.parse(local);
                
                // Load Demo 10m2 Office if nothing found
                return [
                    { id: uuidv4(), tag: 'SLB-01', levelId: 'L1', type: 'IFCSLAB', color: '#475569', params: { width: 4.4, depth: 2.9 }, data: { materialKey: 'CONCRETE_C25' }, position: [0, 0, 0], rotation: [0, 0, 0] },
                    { id: uuidv4(), tag: 'WAL-01', levelId: 'L1', type: 'IFCWALL', color: '#64748b', params: { length: 4.4, height: 3, thickness: 0.2 }, data: { materialKey: 'CONCRETE_C25' }, position: [0, 0.2, -1.35], rotation: [0, 0, 0] },
                    { id: uuidv4(), tag: 'WAL-02', levelId: 'L1', type: 'IFCWALL', color: '#64748b', params: { length: 4.4, height: 3, thickness: 0.2 }, data: { materialKey: 'CONCRETE_C25' }, position: [0, 0.2, 1.35], rotation: [0, 0, 0] },
                    { id: uuidv4(), tag: 'WAL-03', levelId: 'L1', type: 'IFCWALL', color: '#64748b', params: { length: 2.5, height: 3, thickness: 0.2 }, data: { materialKey: 'CONCRETE_C25' }, position: [2.1, 0.2, 0], rotation: [0, Math.PI/2, 0] },
                    { id: uuidv4(), tag: 'WAL-04', levelId: 'L1', type: 'IFCWALL', color: '#64748b', params: { length: 2.5, height: 3, thickness: 0.2 }, data: { materialKey: 'CONCRETE_C25' }, position: [-2.1, 0.2, 0], rotation: [0, Math.PI/2, 0] },
                    { id: uuidv4(), tag: 'COL-01', levelId: 'L1', type: 'IFCCOLUMN', color: '#f59e0b', params: { height: 3, width: 0.3, depth: 0.3 }, data: { materialKey: 'STEEL_S355' }, position: [-1.75, 0.2, -1.05], rotation: [0, 0, 0] },
                    { id: uuidv4(), tag: 'COL-02', levelId: 'L1', type: 'IFCCOLUMN', color: '#f59e0b', params: { height: 3, width: 0.3, depth: 0.3 }, data: { materialKey: 'STEEL_S355' }, position: [1.75, 0.2, -1.05], rotation: [0, 0, 0] },
                    { id: uuidv4(), tag: 'FUR-01', levelId: 'L1', type: 'IFCFURNISHING', color: '#8b5cf6', params: { width: 1.6, height: 0.75, depth: 0.8 }, data: { materialKey: 'COMPOSITE' }, position: [0, 0.2, -0.6], rotation: [0, 0, 0] },
                    { id: uuidv4(), tag: 'FUR-02', levelId: 'L1', type: 'IFCFURNISHING', color: '#8b5cf6', params: { width: 0.6, height: 0.5, depth: 0.6 }, data: { materialKey: 'FURNITURE' }, position: [0, 0.2, 0.3], rotation: [0, 0, 0] }
                ];
            });
            const [materials, setMaterials] = useState(() => JSON.parse(localStorage.getItem('trax_materials')) || INITIAL_MATERIALS);
            // New Project Meta State
            const [projectMeta, setProjectMeta] = useState(() => JSON.parse(localStorage.getItem('trax_project_meta')) || DEFAULT_PROJECT_META);
            
            const [selectedId, setSelectedId] = useState(null);
            const [mode, setMode] = useState('select'); 
            const [orbitEnabled, setOrbitEnabled] = useState(true);
            const [viewMode, setViewMode] = useState('GHOST');
            const [layerVis, setLayerVis] = useState({'IFCWALL': true, 'IFCCOLUMN': true, 'IFCSLAB': true, 'IFCFURNISHING': true});
            const [snap, setSnap] = useState(true);
            
            const [showInfo, setShowInfo] = useState(true);
            const [showProject, setShowProject] = useState(false);
            const [showBoq, setShowBoq] = useState(false);
            const [showImport, setShowImport] = useState(false);
            const [showCostDrivers, setShowCostDrivers] = useState(false);
            const [svgInput, setSvgInput] = useState("");
            const fileInputRef = useRef(null);

            const activeLevel = levels.find(l => l.id === activeLevelId);
            const selectedElement = useMemo(() => elements.find(e => e.id === selectedId), [elements, selectedId]);

            // Persistence
            useEffect(() => { localStorage.setItem('trax_levels', JSON.stringify(levels)); }, [levels]);
            useEffect(() => { localStorage.setItem('trax_elements', JSON.stringify(elements)); }, [elements]);
            useEffect(() => { localStorage.setItem('trax_materials', JSON.stringify(materials)); }, [materials]);
            useEffect(() => { localStorage.setItem('trax_project_meta', JSON.stringify(projectMeta)); }, [projectMeta]);

            const updateLevel = (id, newElev) => {
                setLevels(levels.map(l => l.id === id ? { ...l, elevation: newElev } : l));
            };

            const addLevel = () => {
                const nextId = `L${levels.length + 1}`;
                const prevElev = levels[levels.length-1].elevation;
                setLevels([...levels, { id: nextId, name: `Level ${levels.length + 1}`, elevation: prevElev + 4 }]);
                setActiveLevelId(nextId);
            };

            const handleUpdate = useCallback((id, obj) => {
                setElements(prev => prev.map(el => 
                    el.id === id ? { ...el, position: [obj.position.x, obj.position.y, obj.position.z], rotation: [obj.rotation.x, obj.rotation.y, obj.rotation.z] } : el
                ));
            }, []);

            const projectStats = useMemo(() => {
                let totalCost = 0;
                let totalCount = 0;
                let totalGFA = 0;
                const levelStats = {};
                levels.forEach(l => levelStats[l.id] = { name: l.name, cost: 0, gfa: 0, items: 0 });

                elements.forEach(el => {
                    const matKey = el.data?.materialKey || 'CONCRETE_C25';
                    const mat = materials[matKey] || materials['CONCRETE_C25'];
                    const lvl = el.levelId || 'L1';
                    
                    let vol = 1;
                    const p = el.params;
                    if(el.type === 'IFCWALL') vol = p.length * p.height * p.thickness;
                    else if(el.type === 'IFCCOLUMN') vol = p.height * p.width * p.depth;
                    else if(el.type === 'IFCSLAB') vol = p.width * 0.2 * p.depth;

                    let cost = (mat.unit === 'item') ? mat.cost : vol * mat.cost;

                    if(el.type === 'IFCSLAB') {
                        const area = p.width * p.depth;
                        if(levelStats[lvl]) levelStats[lvl].gfa += area;
                        totalGFA += area;
                    }
                    if(levelStats[lvl]) {
                        levelStats[lvl].cost += cost;
                        levelStats[lvl].items += 1;
                    }
                    totalCost += cost;
                    totalCount++;
                });
                return { totalCost, totalCount, totalGFA, levelStats };
            }, [elements, materials, levels]);

            const parseSVG = () => {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(svgInput, "image/svg+xml");
                    const newEls = [];
                    const errorNode = doc.querySelector('parsererror');
                    if (errorNode) throw new Error("Invalid SVG Format");
                    
                    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                    const rawLines = [];

                    // 1. Extract standard <line> tags
                    doc.querySelectorAll('line').forEach((line) => {
                        const x1 = parseFloat(line.getAttribute('x1'));
                        const y1 = parseFloat(line.getAttribute('y1'));
                        const x2 = parseFloat(line.getAttribute('x2'));
                        const y2 = parseFloat(line.getAttribute('y2'));
                        if(!isNaN(x1) && !isNaN(y1) && !isNaN(x2) && !isNaN(y2)) {
                            rawLines.push({x1, y1, x2, y2});
                            minX = Math.min(minX, x1, x2); minY = Math.min(minY, y1, y2);
                            maxX = Math.max(maxX, x1, x2); maxY = Math.max(maxY, y1, y2);
                        }
                    });

                    // 2. Extract <rect> tags (often used for columns/rooms in CAD)
                    doc.querySelectorAll('rect').forEach((rect) => {
                        const x = parseFloat(rect.getAttribute('x'));
                        const y = parseFloat(rect.getAttribute('y'));
                        const w = parseFloat(rect.getAttribute('width'));
                        const h = parseFloat(rect.getAttribute('height'));
                        if(!isNaN(x) && !isNaN(y) && !isNaN(w) && !isNaN(h)) {
                            rawLines.push({x1: x, y1: y, x2: x+w, y2: y});
                            rawLines.push({x1: x+w, y1: y, x2: x+w, y2: y+h});
                            rawLines.push({x1: x+w, y1: y+h, x2: x, y2: y+h});
                            rawLines.push({x1: x, y1: y+h, x2: x, y2: y});
                            minX = Math.min(minX, x); minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x+w); maxY = Math.max(maxY, y+h);
                        }
                    });

                    // 3. Extract <path> tags (Inkscape/CAD exports heavy line-work as paths)
                    doc.querySelectorAll('path').forEach(path => {
                        const d = path.getAttribute('d');
                        if (!d) return;
                        
                        // Rudimentary path parser focusing on Move (M) and Line (L) commands
                        const commands = d.match(/[A-Za-z][^A-Za-z]*/g);
                        if (!commands) return;
                        
                        let cx = 0, cy = 0;
                        commands.forEach(cmd => {
                            const type = cmd[0].toUpperCase();
                            const args = cmd.slice(1).trim().replace(/,/g, ' ').split(/\s+/).filter(a=>a).map(parseFloat);
                            
                            if (type === 'M' && args.length >= 2) {
                                cx = args[0]; cy = args[1];
                                minX = Math.min(minX, cx); minY = Math.min(minY, cy);
                                maxX = Math.max(maxX, cx); maxY = Math.max(maxY, cy);
                            } else if (type === 'L' && args.length >= 2) {
                                for(let j=0; j<args.length; j+=2) {
                                    const nx = args[j], ny = args[j+1];
                                    if(!isNaN(nx) && !isNaN(ny)) {
                                        rawLines.push({x1: cx, y1: cy, x2: nx, y2: ny});
                                        cx = nx; cy = ny;
                                        minX = Math.min(minX, cx); minY = Math.min(minY, cy);
                                        maxX = Math.max(maxX, cx); maxY = Math.max(maxY, cy);
                                    }
                                }
                            }
                        });
                    });

                    if (rawLines.length === 0) {
                        throw new Error("No valid line, rect, or path geometry found in SVG.");
                    }

                    // Auto-Scale & Centering Logic
                    const width = maxX - minX;
                    const height = maxY - minY;
                    const centerX = (minX + maxX) / 2;
                    const centerY = (minY + maxY) / 2;
                    
                    // Fit to a standard 40x40 meter architectural grid block
                    const TARGET_SIZE = 40; 
                    const maxDim = Math.max(width, height);
                    const scale = maxDim > 0 ? (TARGET_SIZE / maxDim) : 1;

                    rawLines.forEach((line, i) => {
                        // Normalize origin to (0,0) and scale to meters
                        const sx1 = (line.x1 - centerX) * scale;
                        const sy1 = (line.y1 - centerY) * scale;
                        const sx2 = (line.x2 - centerX) * scale;
                        const sy2 = (line.y2 - centerY) * scale;

                        const dx = sx2 - sx1;
                        const dz = sy2 - sy1;
                        const len = Math.sqrt(dx*dx + dz*dz);
                        
                        // Cull microscopic vector artifacts generated during scaling
                        if (len < 0.1) return; 

                        const angle = Math.atan2(dx, dz);
                        const midX = (sx1 + sx2) / 2;
                        const midZ = (sy1 + sy2) / 2;
                        
                        newEls.push({
                            id: uuidv4(), tag: `WAL-${levels.length}${i}`, levelId: activeLevelId,
                            type: 'IFCWALL', color: '#94a3b8',
                            params: { length: len, height: 3, thickness: 0.2 },
                            data: { materialKey: 'CONCRETE_C25' },
                            position: [midX, activeLevel.elevation + 1.5, midZ], rotation: [0, angle, 0]
                        });
                    });

                    // Add an Auto-Sized Slab underpinning the generated geometry
                    const slabWidth = Math.max(20, (width * scale) + 2);
                    const slabDepth = Math.max(20, (height * scale) + 2);

                    newEls.push({
                        id: uuidv4(), tag: `SLB-${activeLevelId}`, levelId: activeLevelId,
                        type: 'IFCSLAB', color: '#64748b',
                        params: { width: slabWidth, depth: slabDepth },
                        data: { materialKey: 'CONCRETE_C25' },
                        position: [0, activeLevel.elevation + 0.1, 0], rotation: [0, 0, 0]
                    });

                    setElements(prev => [...prev, ...newEls]);
                    setShowImport(false);
                } catch (e) {
                    alert("Import Failed: " + e.message);
                }
            };

             const exportCSV = () => {
                // Header Metadata
                const metaRows = [
                    ["PROJECT METADATA"],
                    ["Title", projectMeta.title],
                    ["Code", projectMeta.code],
                    ["Lead", projectMeta.lead],
                    ["Status", projectMeta.status],
                    ["Target Budget", projectMeta.targetBudget],
                    ["Actual Cost", projectStats.totalCost],
                    [],
                    ["OBJECT MANIFEST"]
                ];

                const headers = ["Level", "Tag", "Type", "Material", "LocalX", "LocalY", "LocalZ", "Unit Cost", "Total Cost"];
                const rows = elements.map(el => {
                    const mat = materials[el.data.materialKey] || { name: 'Unknown', cost: 0 };
                    const lvl = levels.find(l => l.id === el.levelId)?.name || 'Unknown';
                    let cost = 0; 
                    // Simple Calc for export
                    let vol = 1;
                    const p = el.params;
                    if(el.type === 'IFCWALL') vol = p.length * p.height * p.thickness;
                    else if(el.type === 'IFCCOLUMN') vol = p.height * p.width * p.depth;
                    else if(el.type === 'IFCSLAB') vol = p.width * 0.2 * p.depth;
                    cost = (mat.unit === 'item') ? mat.cost : vol * mat.cost;

                    return [lvl, el.tag, el.type, mat.name, el.position[0], el.position[1], el.position[2], mat.cost, cost].join(",");
                });
                
                const metaString = metaRows.map(r => r.join(",")).join("\n");
                const dataString = [headers.join(","), ...rows].join("\n");
                
                const csvContent = "data:text/csv;charset=utf-8," + metaString + "\n" + dataString;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `TRAX_${projectMeta.code}_Manifest.csv`);
                document.body.appendChild(link);
                link.click();
            };

            return (
                <div className="w-full h-screen text-slate-800 overflow-hidden relative select-none">
                    
                    {/* TOP BAR */}
                    <div className="absolute top-0 left-0 right-0 h-16 glass-panel border-b border-white z-20 pointer-events-auto flex items-center justify-between px-6">
                        <div className="flex items-center gap-3">
                            <div className="p-1.5 bg-blue-50 rounded-lg border border-blue-100 shadow-sm">
                                <TraxLogo />
                            </div>
                            <div>
                                <h1 className="text-lg font-black tracking-widest text-slate-800 leading-none">TRAX</h1>
                                <div className="text-[9px] font-mono text-slate-500 tracking-[0.2em] font-bold">DATA INTEGRATED MANAGEMENT AUDITOR</div>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-4">
                            <Tooltip text="Project Dashboard & Metering">
                                <button onClick={() => setShowProject(true)} className="p-2 rounded-lg hover:bg-slate-200 text-blue-600 hover:text-blue-800 transition-colors bg-blue-50/50 border border-blue-100">
                                    <Briefcase size={18} />
                                </button>
                            </Tooltip>

                            <Tooltip text="Real-Time BoQ">
                                <button onClick={() => setShowBoq(true)} className="p-2 rounded-lg hover:bg-emerald-100 text-emerald-600 hover:text-emerald-800 transition-colors bg-emerald-50/50 border border-emerald-100">
                                    <ClipboardList size={18} />
                                </button>
                            </Tooltip>
                            
                            <Tooltip text="System Info">
                                <button onClick={() => setShowInfo(true)} className="p-2 rounded-lg hover:bg-slate-200 text-slate-500 hover:text-slate-800 transition-colors">
                                    <Info size={18} />
                                </button>
                            </Tooltip>

                            <div className="flex items-center gap-2 text-xs font-bold text-slate-500 bg-white/50 border border-white p-1 rounded-lg shadow-sm">
                                <Tooltip text="Toggle Grid Snap (0.5m)">
                                    <button onClick={() => setSnap(!snap)} className={`p-1.5 rounded-md flex items-center gap-1 transition-colors ${snap ? 'bg-indigo-600 text-white shadow-md' : 'hover:bg-slate-200'}`}>
                                        <Magnet size={14}/> {snap ? 'SNAP ON' : 'SNAP OFF'}
                                    </button>
                                </Tooltip>
                                <div className="w-px h-4 bg-slate-300"></div>
                                <Tooltip text="Cycle View Modes">
                                    <button onClick={() => setViewMode(v => v === 'ALL' ? 'GHOST' : (v === 'GHOST' ? 'ISOLATE' : 'ALL'))} className="p-1.5 rounded-md hover:bg-slate-200 flex items-center gap-1 transition-colors">
                                        {viewMode === 'ALL' && <Eye size={14} className="text-slate-700"/>}
                                        {viewMode === 'GHOST' && <Layers size={14} className="text-indigo-600"/>}
                                        {viewMode === 'ISOLATE' && <EyeOff size={14} className="text-rose-500"/>}
                                        {viewMode}
                                    </button>
                                </Tooltip>
                            </div>

                            <div className="flex items-center gap-2 bg-white/50 border border-white p-1 rounded-lg shadow-sm">
                                {Object.entries(LAYER_DEFS).map(([type, def]) => {
                                    const Icon = def.icon;
                                    return (
                                        <Tooltip key={type} text={`Toggle ${def.label}`}>
                                            <button 
                                                onClick={() => setLayerVis(p => ({...p, [type]: !p[type]}))} 
                                                className={`p-2 rounded-md transition-all ${layerVis[type] ? 'bg-slate-800 text-white shadow-md' : 'bg-transparent text-slate-400 hover:bg-slate-200'}`}
                                            >
                                                <Icon size={14}/>
                                            </button>
                                        </Tooltip>
                                    )
                                })}
                            </div>

                            <Tooltip text="Export CSV Manifest">
                                <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-xs font-bold transition shadow-lg shadow-emerald-600/20 border border-emerald-500">
                                    <FileSpreadsheet size={14} /> EXPORT
                                </button>
                            </Tooltip>
                        </div>
                    </div>

                    {/* LEFT PANEL */}
                    <div className="absolute left-4 top-24 bottom-4 w-64 z-10 pointer-events-none">
                        <LevelManager 
                            levels={levels} 
                            activeLevelId={activeLevelId} 
                            setActiveLevelId={setActiveLevelId} 
                            addLevel={addLevel}
                            updateLevel={updateLevel}
                            projectStats={projectStats}
                        />
                    </div>

                    {/* RIGHT PANEL */}
                    <div className="absolute right-4 top-24 bottom-4 w-72 flex flex-col gap-4 z-10 pointer-events-none">
                        <div className="glass-panel rounded-xl p-2 pointer-events-auto flex justify-center gap-2 shadow-sm">
                            <Tooltip text="Select Mode">
                                <button onClick={() => setMode('select')} className={`p-2.5 rounded-lg transition-all ${mode === 'select' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:text-slate-800 hover:bg-slate-100'}`}><MousePointer size={20}/></button>
                            </Tooltip>
                            <Tooltip text="Move Mode">
                                <button onClick={() => setMode('translate')} className={`p-2.5 rounded-lg transition-all ${mode === 'translate' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:text-slate-800 hover:bg-slate-100'}`}><Axis3d size={20}/></button>
                            </Tooltip>
                            <div className="w-px bg-slate-200 mx-1"></div>
                            <Tooltip text="Import Data">
                                <button onClick={() => setShowImport(true)} className="p-2.5 rounded-lg text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 transition-colors"><Upload size={20}/></button>
                            </Tooltip>
                            <Tooltip text="Manual Cost Drivers">
                                <button onClick={() => setShowCostDrivers(!showCostDrivers)} className={`p-2.5 rounded-lg transition-all ${showCostDrivers ? 'bg-amber-500 text-white shadow-md' : 'text-amber-500 hover:bg-amber-50'}`}><DollarSign size={20}/></button>
                            </Tooltip>
                        </div>

                        <div className="glass-panel rounded-xl p-4 pointer-events-auto">
                            <div className="flex items-center justify-between mb-2">
                                <h3 className="text-xs font-bold text-slate-400 flex items-center gap-2 tracking-wider"><PieChart size={12}/> TOTAL PROJECT</h3>
                            </div>
                            <div className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500">
                                ${(projectStats.totalCost / 1000).toFixed(1)}k
                            </div>
                            <div className="text-[10px] text-slate-500 mt-1 font-mono font-medium flex justify-between">
                                <span>{projectStats.totalCount} ASSETS</span>
                                <span className={projectStats.totalCost > projectMeta.targetBudget ? "text-red-500 font-bold" : "text-emerald-600"}>
                                    {((projectStats.totalCost / projectMeta.targetBudget) * 100).toFixed(0)}% BUD
                                </span>
                            </div>
                        </div>

                        <PropertyPanel 
                            selectedElement={selectedElement} 
                            materials={materials} 
                            setElements={setElements} 
                            setSelectedId={setSelectedId}
                            elements={elements}
                            showCostDrivers={showCostDrivers}
                            setMaterials={setMaterials}
                            INITIAL_MATERIALS={INITIAL_MATERIALS}
                        />
                    </div>

                    {/* SCREENS */}
                    {showInfo && <InfoScreen onClose={() => setShowInfo(false)} />}
                    {showProject && (
                        <ProjectScreen 
                            meta={projectMeta} 
                            setMeta={setProjectMeta} 
                            stats={projectStats}
                            levels={levels}
                            onClose={() => setShowProject(false)} 
                        />
                    )}
                    {showBoq && (
                        <BoqScreen 
                            elements={elements} 
                            materials={materials} 
                            meta={projectMeta} 
                            onClose={() => setShowBoq(false)} 
                        />
                    )}

                    {/* IMPORT MODAL */}
                    {showImport && (
                        <div className="absolute inset-0 z-50 bg-slate-900/40 flex items-center justify-center p-8 backdrop-blur-sm">
                            <div className="glass-panel rounded-2xl p-8 w-full max-w-2xl flex flex-col pointer-events-auto shadow-2xl">
                                <h2 className="text-xl font-bold text-slate-800 mb-2">IMPORT DATA TO <span className="text-blue-600">{activeLevel.name}</span></h2>
                                <p className="text-xs text-slate-500 mb-6 font-medium">IMPORTED GEOMETRY WILL BE FLATTENED AND EXTRUDED RELATIVE TO LEVEL ELEVATION ({activeLevel.elevation}m)</p>
                                
                                <div onClick={() => fileInputRef.current.click()} className="border-2 border-dashed border-slate-300 hover:border-blue-500 hover:bg-blue-50/50 rounded-xl p-12 flex flex-col items-center justify-center cursor-pointer transition-all group mb-6">
                                    <FileImage size={48} className="text-slate-300 group-hover:text-blue-500 mb-4 transition-colors"/>
                                    <div className="text-sm font-bold text-slate-600 group-hover:text-blue-600">UPLOAD SVG FLOORPLAN</div>
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".svg" onChange={(e) => {
                                        const file = e.target.files[0];
                                        if(!file) return;
                                        const reader = new FileReader();
                                        reader.onload = (ev) => setSvgInput(ev.target.result);
                                        reader.readAsText(file);
                                    }} />
                                </div>

                                <div className="flex justify-end gap-3">
                                    <button onClick={() => setShowImport(false)} className="px-6 py-2 rounded-lg text-slate-500 hover:bg-slate-100 text-xs font-bold transition-colors">CANCEL</button>
                                    <button onClick={parseSVG} disabled={!svgInput} className="px-8 py-2 bg-blue-600 disabled:opacity-50 hover:bg-blue-500 text-white rounded-lg text-xs font-bold transition shadow-lg shadow-blue-500/20">PROCESS IMPORT</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* CANVAS */}
                    <div className="absolute inset-0">
                        <Suspense fallback={null}>
                            <Canvas shadows dpr={[1, 2]} gl={{ preserveDrawingBuffer: true, antialias: true }}>
                                <PerspectiveCamera makeDefault position={[15, 20, 15]} fov={35} />
                                <OrbitControls makeDefault enableDamping dampingFactor={0.1} enabled={orbitEnabled} maxPolarAngle={Math.PI/2 - 0.1} />
                                <SceneGraph 
                                    levels={levels}
                                    elements={elements}
                                    activeLevelId={activeLevelId}
                                    viewMode={viewMode}
                                    layerVis={layerVis}
                                    materials={materials}
                                    mode={mode}
                                    selectedId={selectedId}
                                    setSelectedId={setSelectedId}
                                    handleUpdate={handleUpdate}
                                    setOrbitEnabled={setOrbitEnabled}
                                    snap={snap}
                                />
                            </Canvas>
                        </Suspense>
                    </div>

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<TraxApp />);
    </script>
</body>
</html>
